---
title: "Descriptic statitics of the respiratory diseases burden report from DGE"
author: " IMELDA"
date: "2025-08-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

rm(list = ls())      # clear memory (removes all the variables from the workspace)

```

# 01 Check working directory this is very important since many sub-folder paths depend on this

```{r}

# getwd()
mainpath<- "C:/Users/Imelda Trejo/OneDrive - UNIVERSIDAD NACIONAL AUTÓNOMA DE MÉXICO/CCM_UNAM/Research/Salud_publica/Influenza_Ejes_2025/data/"

```

# 02 Load packages functions and data

```{r read data sets}

library(dplyr)
library(tidyr)
library(ggplot2)

## Load model functions 

source('functions_flu.R')

load(paste0(mainpath,"clean_population.RData") )

load(paste0(mainpath,"respiratory_data_2025-08-05.RData") )


```
# 03 MEXICAN' STATES LOCATIONS AND DISTRIBUTION   

The data was freely dowloded from Dirección General de Epidemiologia (DGE).
All observation correspond to respiratory diseases reports from USMER. 

```{r ORIGIN}
print(summary(data_DGE$ORIGEN))
```
All hospital that fuels USMER are ploted below, is there the total user for each sector. Will be interesting to know the capacity usaged.


```{r SECTOR}

ggplot(data_DGE, aes(x = SECTOR)) +
  geom_bar(fill = "steelblue") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +  # rotar 45 grados
  labs(title = "Frecuencia de Sectores USMER", x = "sectores", y = "Cantidad")


```
The distribution of sector stratify by states where a Medical Units (UM) is located

```{r SECTOR in all country}
# cross tables
  resumen <- data_DGE %>%
  group_by(SECTOR, ENTIDAD_UM) %>%
  summarise(count = n(), .groups = "drop")

#  plot
ggplot(resumen, aes(x = ENTIDAD_UM, y = count, fill = SECTOR)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Distributionof SECTORS in Mexico",
       x = "State",
       y = "Number of users",
       fill = "SECTOR") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) # rotar 45 grados


```


There are some people who may travel to get medical assistance at their Unit Medical place (UM)

```{r}
#cross table
resumen2 <- data_DGE %>%
  group_by(ENTIDAD_RES, ENTIDAD_UM) %>%
  summarise(count = n(), .groups = "drop")

print(resumen2)
```

#04 AGE CHARACTERISTIC

```{r}
summary(data_DGE$EDAD)

#Distribución por grupos de edad

# 1. Count cases by age group
users_by_age <- data_DGE %>%
  count(GRUPO_EDAD, name = "users")%>%
  rename(AGE_GROUP = GRUPO_EDAD)


# 2. Get population totals for 2025
population_total <- population %>%
  filter(Year == 2025) %>%
  select(AGE_GROUP, POPULATION)

# 3. Join and calculate rates (per 100,000 people here)
rate_age_grp <- users_by_age %>%
  left_join(population_total) %>%
  mutate(rate_per_100k = round((users* 100000 / POPULATION), 2)) %>%
  select(AGE_GROUP, users, POPULATION, rate_per_100k)

ggplot(rate_age_grp, aes(x = "", y = rate_per_100k, fill = AGE_GROUP)) +
  geom_col() +
  coord_polar(theta = "y") +
  labs(title = "Users by Age Group (Proportion)") +
  theme_minimal()


# Rates per 100k by age group
ggplot(rate_age_grp, aes(x = AGE_GROUP, y = rate_per_100k, fill = AGE_GROUP)) +
  geom_col() +
  labs(title = "User Rate per 100,000 by Age Group", y = "Rate per 100,000", x = "Age Group") +
  theme_minimal() +
  theme(legend.position = "none")

```

```{r}
# DISTRIBUTION BY AGE
ggplot(data_DGE, aes(x = EDAD)) +
  geom_histogram(bins = 30, fill = "lightblue", color = "black", alpha = 0.7) +
  geom_vline(aes(xintercept = mean(EDAD, na.rm = TRUE)), 
             color = "red", linetype = "dashed", size = 1) +
  labs(title = "DistribuciOn de Edad de Pacientes con Enfermedades Respiratorias",
       subtitle = paste("Edad promedio:", round(mean(data_DGE$EDAD, na.rm = TRUE), 1), "YEARS"),
       x = "Edad (YEARS)", 
       y = "Frecuencia") +
  theme_minimal()


# Pirámide poblacional por sexo y grupo de edad
piramide_data <- data_DGE %>%
  filter(!is.na(SEXO), !is.na(GRUPO_EDAD)) %>%
  group_by(SEXO, GRUPO_EDAD) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(
    count_adj = ifelse(SEXO == "HOMBRE", -count, count),
    porcentaje = round((count / sum(count)) * 100, 1)
  )

ggplot(piramide_data, aes(x = count_adj, y = GRUPO_EDAD, fill = SEXO)) +
  geom_bar(stat = "identity") +
  scale_x_continuous(labels = function(x) abs(x), 
                     breaks = seq(-max(abs(piramide_data$count_adj)), 
                                  max(abs(piramide_data$count_adj)), 
                                  by = 2000)) +
  scale_fill_manual(values = c("MUJER" = "pink", "HOMBRE" = "lightblue")) +
  labs(title = "PirAmide Poblacional: Casos de Enfermedades Respiratorias por Sexo y Edad",
       x = "Número de casos", 
       y = "Grupo de edad",
       fill = "Sexo") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

