---
title: "Influenza burden in Mexico, as 2025"
author: "IMELDA"
date: "2025-08-24, last update August 24, 2025"
output: 
  html_document: 
    toc: true
    toc_depth: 3
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

rm(list = ls())      # Clear memory (remove all variables from workspace)

#call libraries

library(dplyr)
library(tidyr)
library(ggplot2)
library(janitor)
```

# 01 Check working directory

(Important since many sub-folder paths depend on this)

```{r load data}
# Define inputs

year_analysis <- 2024
date_analysis <- "2024-12-03"

#year_analysis <- 2025
#date_analysis <- "2025-08-05"

file_name <- paste0("clean_respiratory_diseases_", date_analysis, ".Rdata")

# URLs
url_web <- "https://github.com/imelit/Bayesian_inference_class_2025/raw/main/data/"
url_disease <- paste0(url_web, file_name)
url_population <- paste0(url_web, "clean_mexican_population.RData")

# Load data
load(url(url_disease))
load(url(url_population))
```

# 02 Demographics of reported influenza cases

```{r clean data}
# Keep only confirmed influenza cases
data_flu <- data_resp %>%
  filter(CLASIFICACION_FINAL_FLU == "CASO DE INFLUENZA CONFIRMADO")

# this data include all respiratory cases related to flu

# Keep only influenza positive cases
flu <- data_flu %>%
  filter(grepl("INFLUENZA", RESULTADO_PCR, ignore.case = TRUE))



summary(flu)
```
Nota: Aunque se incluyen todas las clasificaciones por PCR, sólo las categorías con “INFLUENZA” corresponden a casos confirmados.

# 03 Demographics of reported influenza cases
## 03.1 Sectors attending cases
```{r medial unit acrros Mexico}
cross_table_sectorEntidad <- data_flu %>%
  group_by(SECTOR, ENTIDAD_UM) %>%
  summarise(count = n(), .groups = "drop")

ggplot(cross_table_sectorEntidad, aes(x = ENTIDAD_UM, y = count, fill = SECTOR)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = paste("Distribution of sectors attending influenza cases by state in", year_analysis),
    x = "State",
    y = "Number of cases",
    fill = "Sector"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5, face = "bold")
  )
```
Nota: La mayoría de los casos son atendidos en el sector público, aunque la distribución varía entre estados. Esto puede reflejar diferencias en acceso a servicios de salud.

# 04 Influenza types

```{r cases by types}
ggplot(flu, aes(x = RESULTADO_PCR, fill = RESULTADO_PCR)) +
  geom_bar() +
  labs(
    title = paste("Frequency of confirmed influenza by type in", year_analysis),
    x = "Influenza type",
    y = "Number of cases"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

Nota: Los subtipos más frecuentes permiten identificar qué cepas dominaron en la temporada. Esta información es clave para la planeación de la vacuna. Cuando se distribuyen las vacunas? ¿Para cuantos subtipo esta diseñanda una vacuna en Mexico?

## 04.1 Influenza cases stratified by age groups

```{r cases by age group}


cases_by_age <- flu %>% count(AGE_GROUP, name = "Cases")

population_total <- population %>%
  filter(Year == year_analysis) %>%
  select(AGE_GROUP, POPULATION)

rate_age_grp <- cases_by_age %>%
  left_join(population_total) %>%
  mutate(rate_per_100k = round((Cases * 100000 / POPULATION), 2))

ggplot(rate_age_grp, aes(x = AGE_GROUP, y = rate_per_100k, fill = AGE_GROUP)) +
  geom_col() +
  labs(
    title = paste("Influenza cases per 100,000 by age group in", year_analysis),
    y = "Rate per 100,000",
    x = "Age Group"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

```
Nota: Los grupos de edad extremos (niños pequeños y adultos mayores) suelen mostrar mayores tasas de incidencia, reflejando vulnerabilidad biológica y la importancia de la vacunación.

## 04.2 Daily influenza cases

```{r daily reports}
daily_cases_by_type <- flu %>%
  group_by(FECHA_SINTOMAS, RESULTADO_PCR, AGE_GROUP) %>%
  summarise(CASOS = n(), .groups = "drop") 

# Total daily confirmed cases
ggplot(daily_cases_by_type, aes(x = FECHA_SINTOMAS, y = CASOS)) +
  geom_line() +
  labs(
    title = paste("Daily confirmed influenza cases in", year_analysis),
    x = "Symptom onset date",
    y = "Number of cases"
  ) +
  theme_minimal()

```
Nota: El patrón temporal muestra la estacionalidad de influenza, con picos concentrados en invierno y principios de primavera.

```{r daily cases by flu types}
# Daily cases by type
ggplot(daily_cases_by_type, aes(x = FECHA_SINTOMAS, y = CASOS, color = RESULTADO_PCR)) +
  geom_line() +
  labs(
    title = paste("Daily confirmed influenza cases by type in", year_analysis),
    x = "Symptom onset date",
    y = "Number of cases",
    color = "PCR result"
  ) +
  theme_minimal()
```
Nota: Algunos subtipos dominan en el pico epidémico, lo que sugiere su mayor transmisibilidad en cada sub-brote.



```{r daily cases by fly types by age group}
# Faceted by age group
ggplot(daily_cases_by_type, aes(x = FECHA_SINTOMAS, y = CASOS, color = RESULTADO_PCR)) +
  geom_line() +
  facet_wrap(~AGE_GROUP, scales = "free_y") +
  labs(
    title = paste("Daily confirmed influenza cases by type and age group in", year_analysis),
    x = "Symptom onset date",
    y = "Number of cases",
    color = "PCR result"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
Nota: es interesante ver el brote epidÉmico por influenza B para el grupo de edad 5-19 y 20-64 años, que no es tan evidente como los brotes por influenza AH1N1 y AH3.
